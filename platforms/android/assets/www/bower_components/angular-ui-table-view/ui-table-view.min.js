"use strict";function UITableView(scope,element,attr,$timeout){function render(){bufferedItems=element.children().children();for(var i=0;i<tv.buffer.items.length;i++){var item=tv.buffer.items[i],bufferedItem=angular.element(bufferedItems[i]);bufferedItem.css({position:"absolute",width:"100%",height:tv.row.height+"px",webkitTransform:"translateY("+item.top+"px)"})}}function moveViewWindowUp(){for(var j=1,newItems=tv.allItems.slice(tv.window.startIndex-tv.scroll.deltaIndex,tv.window.startIndex),i=tv.scroll.deltaIndex-1;i>=0;i--)if(void 0!==newItems[i]){decreaseBufferPointer(),newItems[i].top=tv.window.startPx-tv.row.height*j++,angular.extend(tv.buffer.items[tv.buffer.pointer],newItems[i]);var bufferedItem=angular.element(bufferedItems[tv.buffer.pointer]);bufferedItem&&bufferedItem.css("-webkit-transform","translateY("+newItems[i].top+"px)")}tv.window.startIndex-=tv.scroll.deltaIndex,tv.window.endIndex-=tv.scroll.deltaIndex,updateViewWindow()}function moveViewWindowDown(){for(var newItems=tv.allItems.slice(tv.window.endIndex+1,tv.window.endIndex+1+tv.scroll.deltaIndex),i=0;i<tv.scroll.deltaIndex;i++)if(void 0!==newItems[i]){newItems[i].top=tv.window.endPx+tv.row.height*i,angular.extend(tv.buffer.items[tv.buffer.pointer],newItems[i]);var bufferedItem=angular.element(bufferedItems[tv.buffer.pointer]);bufferedItem&&bufferedItem.css("-webkit-transform","translateY("+newItems[i].top+"px)"),increaseBufferPointer()}else console.log("Over reached with the index delta",newItems.length,tv.scroll.deltaIndex);tv.window.startIndex+=tv.scroll.deltaIndex,tv.window.endIndex+=tv.scroll.deltaIndex,updateViewWindow()}function updateViewWindow(){tv.window.startPx=tv.window.startIndex*tv.row.height,tv.window.endPx=(tv.window.endIndex+1)*tv.row.height}function increaseBufferPointer(){tv.buffer.pointer++,tv.buffer.pointer>=tv.buffer.size&&(tv.buffer.pointer=0)}function decreaseBufferPointer(){tv.buffer.pointer--,tv.buffer.pointer<0&&(tv.buffer.pointer=tv.buffer.size-1)}var BUFFER_SIZE=20,ROW_HEIGHT=40,ROW_WIDTH="100%",tv={},container=element,wrapper=angular.element(container.children()),bufferedItems=element.children().children();return container.css("overflow","auto"),container.addClass("mlz-ui-table-view"),wrapper.css("position","relative"),tv.container={height:container.attr("height")||container.prop("clientHeight"),width:container.attr("width")||container.prop("clientWidth")},tv.wrapper={height:0,width:tv.container.width||0},tv.row={height:+attr.mlzUiTableViewRowHeight||ROW_HEIGHT,width:+attr.mlzUiTableViewColumnWidth||ROW_WIDTH},tv.allItems=scope.$eval(attr.mlzUiTableView)||[],tv.scroll={_y:0,y:0,deltaY:0,index:0,_index:0,deltaIndex:0,direction:"down",height:0,width:0},tv.buffer={size:+attr.mlzUiTableViewBufferSize||BUFFER_SIZE,visible:0,items:angular.copy(bufferedItems),pointer:0},tv.items=tv.buffer.items,tv.window={startIndex:0,startPx:0,endIndex:tv.buffer.size-1||BUFFER_SIZE,endPx:tv.buffer.size*tv.row.height||BUFFER_SIZE*ROW_HEIGHT},tv.initialise=function(){tv.buffer.visible=Math.ceil(tv.container.height/tv.row.height)+1,render()},tv.setScrollPosition=function(y){tv.scroll.y=y,tv.scroll.deltaY=y-tv.scroll._y,tv.scroll._y=y,tv.scroll.index=Math.abs(Math.floor(y/tv.row.height)),tv.scroll.deltaIndex=Math.abs(tv.scroll.index-tv.scroll._index),tv.scroll._index=tv.scroll.index,tv.scroll.direction=tv.scroll.deltaY>=0?"down":"up",0!==tv.scroll.deltaIndex&&("down"===tv.scroll.direction?moveViewWindowDown():moveViewWindowUp())},tv.scrollToTop=function(){element.animate({scrollTop:0},"slow")},tv.updatePositions=function(items){tv.allItems=items,tv.wrapper.height=tv.allItems.length*tv.row.height,wrapper.css("height",tv.wrapper.height+"px"),angular.copy(tv.allItems.slice(tv.window.startIndex,tv.window.endIndex+1),tv.buffer.items);for(var position=tv.buffer.pointer,i=0;i<tv.buffer.items.length;i++)tv.buffer.items[i].$$position=position++,tv.buffer.items[i].height=tv.row.height,tv.buffer.items[i].top=tv.window.startPx+tv.row.height*i,tv.buffer.items[i].$$visible=!1,i<tv.buffer.visible&&(tv.buffer.items[i].$$visible=!0),position>=tv.buffer.items.length&&(position=0);$timeout(function(){render()})},tv}angular.module("mallzee.ui-table-view",[]).filter("slice",function(){return function(arr,start,end){return arr.slice(start,end)}}).directive("mlzUiTableView",["$window","$timeout",function($window,$timeout){return{restrict:"A",transclude:!1,scope:!0,link:function(scope,element,attributes){scope.tableView=new UITableView(scope,element,attributes,$timeout),scope.tableView.initialise(),scope.$watchCollection("tableView.allItems",function(items){scope.tableView.updatePositions(items)}),$window.addEventListener("statusTap",function(){scope.tableView.scrollToTop()}),element.on("scroll",function(){scope.$apply(function(){scope.tableView.setScrollPosition(element[0].scrollTop)})})}}}]);